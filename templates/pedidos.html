{% extends "base.html" %}
{% block title %}{{ titulo | default('Registro de Pedido') }}{% endblock %}
{% block content %}
<h2 class="mb-4">{{ titulo | default('Registro de Pedido') }}</h2>
<form method="post" id="pedido-form">
    <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="domicilio-check" name="domicilio">
        <label class="form-check-label" for="domicilio-check">Entrega a domicilio</label>
    </div>
    <label for="direccion" class="form-label">Direcci\u00f3n</label>
    <input type="text" class="form-control mb-2" id="direccion" name="direccion" placeholder="Direcci\u00f3n" disabled>
    <div id="productos-container"></div>
    <button type="button" class="btn btn-secondary mt-2" onclick="agregarProducto()">Agregar Producto</button>
    <button type="submit" class="btn btn-primary mt-2">Enviar Pedido</button>
    <datalist id="product-list">
    {% for key, data in products.items() %}
        <option value="{{ data.label }}"></option>
    {% endfor %}
    </datalist>
    <datalist id="adiciones-list">
    {% for nombre in adiciones %}
        <option value="{{ nombre }}"></option>
    {% endfor %}
    </datalist>
</form>

<script>
const PRODUCTS = {{ products | tojson }};
const PRODUCT_KEYS = {};
Object.keys(PRODUCTS).forEach(key => {
    PRODUCT_KEYS[PRODUCTS[key].label] = key;
});

function crearLabel(texto) {
    const label = document.createElement('label');
    label.textContent = texto;
    label.className = 'form-label';
    return label;
}

function crearProductoInput(index) {
    const input = document.createElement('input');
    input.setAttribute('list', 'product-list');
    input.className = 'form-control mb-2';
    input.placeholder = 'Buscar producto';
    input.onchange = () => seleccionarProducto(input, index);
    return input;
}

function crearProductoHidden(index) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'productos';
    input.id = 'producto-key-' + index;
    return input;
}

function seleccionarProducto(input, index) {
    const key = PRODUCT_KEYS[input.value] || '';
    document.getElementById('producto-key-' + index).value = key;
    actualizarTamanos(key, index);
}

function crearCantidadInput() {
    const input = document.createElement('input');
    input.type = 'number';
    input.name = 'cantidades';
    input.className = 'form-control mb-2';
    input.placeholder = 'Cantidad';
    input.min = 1;
    return input;
}

function crearBotonEliminar(callback) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-outline-danger btn-sm';
    btn.textContent = 'Eliminar';
    btn.onclick = callback;
    return btn;
}

function crearAdicionFila(actualizar) {
    const wrap = document.createElement('div');
    wrap.className = 'input-group mb-2 adicion-item';

    const input = document.createElement('input');
    input.setAttribute('list', 'adiciones-list');
    input.className = 'form-control';
    input.placeholder = 'Adici\u00f3n';
    input.oninput = actualizar;

    const btn = crearBotonEliminar(() => {
        wrap.remove();
        actualizar();
    });

    wrap.appendChild(input);
    wrap.appendChild(btn);
    return wrap;
}

function crearContenedorAdiciones(index) {
    const container = document.createElement('div');
    container.className = 'mb-2 adiciones-container';
    container.dataset.index = index;

    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = 'adiciones';
    hidden.id = 'adiciones-' + index;

    function actualizar() {
        const values = Array.from(container.querySelectorAll('input[list="adiciones-list"]'))
            .map(i => i.value.trim())
            .filter(v => v);
        hidden.value = values.join(',');
    }

    container.updateHidden = actualizar;

    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'btn btn-secondary btn-sm mb-2';
    addBtn.textContent = 'Agregar Adici\u00f3n';
    addBtn.onclick = () => {
        container.insertBefore(crearAdicionFila(actualizar), addBtn);
    };

    container.appendChild(hidden);
    container.appendChild(addBtn);
    return container;
}

function crearDetalleTextarea() {
    const textarea = document.createElement('textarea');
    textarea.name = 'detalles';
    textarea.className = 'form-control mb-2';
    textarea.placeholder = 'Detalle del producto';
    return textarea;
}

function crearSelectTamano() {
    const select = document.createElement('select');
    select.name = 'tamanos';
    select.className = 'form-select mb-2';
    return select;
}

function actualizarTamanos(productKey, index) {
    const selectTamano = document.getElementById('tamano-' + index);
    selectTamano.innerHTML = '';
    if (PRODUCTS[productKey]) {
        PRODUCTS[productKey].sizes.forEach(size => {
            const opt = document.createElement('option');
            opt.value = size;
            opt.textContent = size;
            selectTamano.appendChild(opt);
        });
    }
}

let productoIndex = 0;
function agregarProducto() {
    const container = document.getElementById('productos-container');
    const row = document.createElement('div');
    row.className = 'mb-3 border p-2 position-relative';

    const removeBtn = crearBotonEliminar(() => row.remove());
    removeBtn.classList.add('position-absolute', 'top-0', 'end-0');

    const inputProducto = crearProductoInput(productoIndex);
    const hiddenProducto = crearProductoHidden(productoIndex);
    const cantidadInput = crearCantidadInput();
    const selectTamano = crearSelectTamano();
    const adicionesContainer = crearContenedorAdiciones(productoIndex);
    const detalleTextarea = crearDetalleTextarea();

    selectTamano.id = 'tamano-' + productoIndex;

    row.appendChild(removeBtn);
    row.appendChild(crearLabel('Producto'));
    row.appendChild(inputProducto);
    row.appendChild(hiddenProducto);
    row.appendChild(crearLabel('Cantidad'));
    row.appendChild(cantidadInput);
    row.appendChild(crearLabel('Tama\u00f1o'));
    row.appendChild(selectTamano);
    row.appendChild(crearLabel('Adiciones'));
    row.appendChild(adicionesContainer);
    row.appendChild(crearLabel('Detalle'));
    row.appendChild(detalleTextarea);

    container.appendChild(row);
    productoIndex += 1;
}

    document.addEventListener('DOMContentLoaded', () => {
        agregarProducto();

        const domicilioCheck = document.getElementById('domicilio-check');
        const direccionInput = document.getElementById('direccion');
        const form = document.getElementById('pedido-form');

        function toggleForm(disabled) {
            form.querySelectorAll('input, select, textarea, button').forEach(el => {
                if (el !== direccionInput && el !== domicilioCheck) {
                    el.disabled = disabled;
                }
            });
        }

        function direccionValida() {
            return direccionInput.value.trim().length > 5;
        }

        function validarDireccion() {
            if (domicilioCheck.checked) {
                toggleForm(!direccionValida());
            }
        }

        domicilioCheck.addEventListener('change', () => {
            if (domicilioCheck.checked) {
                direccionInput.disabled = false;
                direccionInput.required = true;
                validarDireccion();
            } else {
                direccionInput.disabled = true;
                direccionInput.required = false;
                direccionInput.value = '';
                toggleForm(false);
            }
        });

        direccionInput.addEventListener('input', validarDireccion);

        document.getElementById('pedido-form').addEventListener('submit', (e) => {
            document.querySelectorAll(".adiciones-container").forEach(c => { if (typeof c.updateHidden === "function") { c.updateHidden(); } });
            const cantidades = document.querySelectorAll('input[name="cantidades"]');
            for (const input of cantidades) {
                if (parseInt(input.value) <= 0 || isNaN(parseInt(input.value))) {
                    alert('Las cantidades deben ser mayores que cero');
                    e.preventDefault();
                    return;
                }
            }
            if (domicilioCheck.checked && !direccionValida()) {
                alert('Ingrese una dirección válida');
                e.preventDefault();
                return;
            }
        });
    });
</script>
{% endblock %}
